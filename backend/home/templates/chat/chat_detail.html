<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat</title>
    <style>
      .chat-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ddd;
      }
      .chat-messages {
        height: 400px;
        overflow-y: auto;
        border-bottom: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 20px;
      }
      .message {
        padding: 5px 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        display: inline-block;
        max-width: 70%;
      }
      .me {
        background-color: #e0f7fa;
        text-align: right;
        align-self: flex-end;
      }
      .other {
        background-color: #e0e0e0;
        text-align: left;
        align-self: flex-start;
      }
      .timestamp {
        font-size: 0.8em;
        color: #888;
        display: block;
        margin-top: 5px;
      }
      .chat-input-container {
        display: flex;
        gap: 10px;
      }
      #chat-input {
        flex: 1;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
      }
      #send-button {
        padding: 10px 20px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <h2>Chat with {{ other_user.username }}</h2>

      <!-- Chat Messages Container -->
      <div class="chat-messages" id="chat-messages">
        {% for msg in messages %}
        <div
          class="message {% if msg.sender == request.user %}me{% else %}other{% endif %}"
        >
          <strong>{{ msg.sender.username }}:</strong> {{ msg.content }}
          <span class="timestamp">{{ msg.timestamp|date:"H:i, M j" }}</span>
        </div>
        {% endfor %}
      </div>

      <!-- Chat Input and Send Button -->
      <div class="chat-input-container">
        <textarea id="chat-input" placeholder="Type your message"></textarea>
        <button
          id="send-button"
          onclick="sendMessage('{{ item.id }}', '{{ other_user.id }}')"
        >
          Send
        </button>
      </div>
    </div>

    <script>
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      const csrftoken = getCookie('csrftoken');

      function sendMessage(itemId, otherUserId) {
        const content = document.getElementById('chat-input').value;
        if (!content) {
          alert('Message content cannot be empty.');
          return;
        }

        fetch(`/item_request/${itemId}/send_message/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
          },
          body: JSON.stringify({ content }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              appendMessageToChat(data.content, 'me'); // Add message immediately
              document.getElementById('chat-input').value = ''; // Clear input
            } else {
              alert('Failed to send message: ' + data.message);
            }
          })
          .catch((error) => console.error('Error:', error));
      }

      function appendMessageToChat(content, sender) {
        const chatMessages = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add(
          'message',
          sender === 'me' ? 'me' : 'other'
        );
        messageElement.innerHTML = `<strong>${
          sender === 'me' ? 'You' : sender
        }:</strong> ${content}
                                         <span class="timestamp">${new Date().toLocaleTimeString()}</span>`;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the bottom
      }
    </script>
  </body>
</html>
